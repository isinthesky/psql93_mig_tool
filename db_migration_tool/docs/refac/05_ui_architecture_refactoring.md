# 05. UI 계층 정돈 및 ViewModel 도입 계획

## 요약
- `src/ui/main_window.py`, `src/ui/dialogs/*`, `src/ui/widgets/*` 전반에 걸쳐 비즈니스 로직과 Qt 위젯 코드가 섞여 있다.
- 시그널/슬롯이 파일 간에 강하게 결합되어 테스트가 어렵고, 상태 동기화가 여러 곳에서 중복된다.
- 목표는 **ViewModel/Presenter 계층을 도입**해 UI 코드를 슬림화하고, 재사용 가능한 컴포넌트와 상태 관리 구조를 마련하는 것이다.

## 현재 Pain Point
- **이벤트 처리 중복**: 여러 다이얼로그에서 동일한 프로필/이력 로딩 로직을 반복.
- **상태 관리 난해**: `MainWindow`가 워커 스레드, 로그 시그널, 히스토리 업데이트를 직접 관리하면서 함수 길이가 길어짐.
- **테스트 부재**: Qt 위젯에 직접 의존하는 코드가 많아 단위 테스트가 사실상 불가능.
- **확장 난이도**: 새로운 다이얼로그나 뷰를 추가할 때 기존 시그널 체인을 이해하기 어렵고, 버그 발생 시 디버깅이 힘듦.

## 목표 아키텍처
```
src/ui/
├── main_window.py            # 얇은 view, ViewModel 주입
├── dialogs/
│   ├── connection_dialog.py  # view
│   ├── migration_dialog.py   # view
│   └── ...
├── viewmodels/               # 새 폴더: 각 뷰를 위한 상태/액션
│   ├── connection_vm.py
│   ├── migration_vm.py
│   └── main_vm.py
└── services/                 # UI에서 사용하는 고수준 서비스 (선택)
```
- ViewModel은 도메인 로직(프로필 CRUD, 마이그레이션 시작/중단 등)을 담당하고, UI는 시그널/슬롯 연결만 수행.
- 공용 시그널 버스 또는 이벤트 에미터를 도입해 UI 간 통신을 단순화.
- 테스트는 ViewModel 단위로 작성하여 Qt 의존성을 최소화.

## 구현 계획
| 단계 | 작업 | 산출물/검증 포인트 |
|------|------|-------------------|
| 1 | `ui/viewmodels` 디렉토리 생성, 기본 베이스 클래스 설계 | `BaseViewModel`, 단위 테스트 |
| 2 | `MainWindow` 로직 분리 (`main_vm.py` 작성) | 상태/액션 메서드 정의, 메인 윈도우 리팩토링 |
| 3 | `connection_dialog.py` → `ConnectionViewModel` 도입 | 기존 플로우 동일하게 동작 |
| 4 | `migration_dialog.py`, 기타 다이얼로그 적용 | 반복 로직 제거, 테스트 추가 |
| 5 | 공용 서비스/시그널 버스 정리 | 이벤트 흐름 문서화 |

## 완료 기준
- `MainWindow`와 각 다이얼로그가 ViewModel 인스턴스를 생성(또는 주입)해서 사용한다.
- UI 클래스 내에서 DB 접근 또는 파일 I/O가 직접 발생하지 않는다.
- ViewModel 단위 테스트가 추가되며, UI 테스트는 주요 시그널 연결만 검증하면 된다.
- 기존 사용자 플로우(프로필 생성/편집, 마이그레이션 실행, 로그 뷰 확인)가 회귀 없이 동작한다.

## 위험 & 대응
- **시그널 미연결**: 리팩토링 과정에서 슬롯 연결이 누락될 수 있음 → ViewModel과 View 사이 인터페이스를 명세화하고, smoke 테스트 수행.
- **상태 중복 관리**: View와 ViewModel이 동일한 상태를 보관할 수 있음 → 단방향 데이터 흐름 규칙을 문서화.
- **대규모 수정으로 인한 회귀**: UI 전체가 영향을 받으므로 단계별 브랜치와 기능 플래그 도입 고려.

## 테스트 전략
- **단위 테스트**: ViewModel 메서드(프로필 로딩, 마이그레이션 시작/중단, 로그 수신 처리)를 pytest로 검증.
- **통합 테스트 (`pytest-qt`)**: 주요 UI 플로우가 ViewModel 도입 후에도 동일하게 동작하는지 확인.
- **수동 테스트 체크리스트**: 마이그레이션 시작/중단, 로그 확인, 프로필 CRUD 등 핵심 시나리오 5가지 이상을 QA 스크립트로 수행.

## 롤아웃/롤백 노트
- 각 ViewModel 도입을 개별 PR로 나누고, 병행 기간 동안 기존 로직을 유지하는 기능 토글을 둘 수 있다.
- 문제 발생 시 해당 뷰의 ViewModel 전환 커밋만 롤백하고, 기존 뷰 로직으로 되돌릴 수 있도록 작은 단위로 진행.
- ViewModel 패턴이 정착되면 다른 팀원이 새 뷰를 추가할 때 템플릿으로 활용할 수 있도록 코드 예제와 문서를 업데이트한다.
